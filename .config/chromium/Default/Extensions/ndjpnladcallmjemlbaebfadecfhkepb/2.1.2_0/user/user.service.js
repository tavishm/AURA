!function(){"use strict";angular.module("app.user",[]).factory("userService",["$q","$log","$injector","constants","storage","notification","msaUserService","o365UserService",function(e,r,n,t,i,o,s,u){function l(e,o,s,u){3===arguments.length&&"[object Function]"===Object.prototype.toString.call(s)?(u=s,s=null):2===arguments.length&&"[object Function]"===Object.prototype.toString.call(o)&&(u=o,o=null);var l=a(e);if(Utilities.isUndefinedOrNull(l))return r.error("userService.acquireToken - Invalid type"),void u(null);var c=l.getConfig();c.params.grant_type=t.OAUTH.REFRESH_TOKEN,4!==arguments.length&&3!==arguments.length||l.type!==t.USER_TYPE.O365||(Utilities.isUndefinedOrNull(s)?c.resource=l.getResourceForEndpoint(o):c.resource=s,c.params.resource=c.resource),function(e,r){i.get("accessToken").then((function(n){var t,i;Utilities.isUndefinedOrNull(n.accessToken)||Utilities.isUndefinedOrNull(n.accessToken[e])?r(null):(t=n.accessToken[e].expires_on,i=Utilities.getCurrentTime(),r(t&&t>i+120?n.accessToken[e].access_token:null))}))}(c.resource,(function(e){Utilities.isNotUndefinedOrNull(e)?u(e):function(e,r){i.get("refreshToken").then((function(n){Utilities.isUndefinedOrNull(n.refreshToken)||Utilities.isUndefinedOrNull(n.refreshToken[e])?r(null):r(n.refreshToken[e])}))}(l.type,(function(e){Utilities.isUndefinedOrNull(e)||Utilities.isUndefinedOrNull(e)?u(null):(c.params.refresh_token=e,n.get("$http")({method:"POST",url:c.url,headers:{"Content-Type":"application/x-www-form-urlencoded;charset=utf-8"},data:$.param(c.params)}).success((function(e){U(c.resource,e),d(l.type,e),i.set({userType:l.type}),u(e.access_token)})).error((function(){f(),u(null)})))}))}))}function f(){i.remove("accessToken"),i.remove("refreshToken"),i.remove("userInfo"),i.remove("userType")}function c(e){i.get("userType").then((function(r){Utilities.isUndefinedOrNull(r.userType)?e(!1):l(r.userType,(function(r){e(Utilities.isNotUndefinedOrNull(r))}))}))}function a(e){var n=null;return-1!==e.indexOf(t.USER_TYPE.MSA)?n=s:-1!==e.indexOf(t.USER_TYPE.O365)?n=u:r.error(String.format("userService.getUserServiceProvider - Invalid type - {0}",e)),n}function d(e,r){i.get("refreshToken").then((function(n){Utilities.isUndefinedOrNull(n.refreshToken)&&(n.refreshToken={}),n.refreshToken[e]=r.refresh_token,i.set(n)}))}function U(e,r){Utilities.isUndefinedOrNull(r.expires_on)&&(r.expires_on=Utilities.getCurrentTime()+r.expires_in),i.get("accessToken").then((function(n){Utilities.isUndefinedOrNull(n.accessToken)&&(n.accessToken={}),n.accessToken[e]=r,i.set(n)}))}function p(e,r){i.get("userInfo").then((function(n){Utilities.isUndefinedOrNull(n.userInfo)||Utilities.isUndefinedOrNull(n.userInfo[e])?r(null):r(n.userInfo[e])}))}function T(r,n){var o=e.defer();return i.get("userInfo").then((function(e){Utilities.isUndefinedOrNull(e.userInfo)&&(e.userInfo={}),e.userInfo[r]={},e.userInfo[r].email=n.email,e.userInfo[r].puid=n.puid,e.userInfo[r].tid=n.tid,e.userInfo[r].cid=n.cid,e.userInfo[r].flights=n.flights,e.userInfo[r].features=n.features,e.userInfo[r].photo=n.photo,e.userInfo[r].oneDriveUrl=n.oneDriveUrl,e.userInfo[r].sharePointUrl=n.sharePointUrl;var s=new RegExp("(?:(?:[a-z\\u00a1-\\uffff0-9][-_]*)*[a-z\\u00a1-\\uffff0-9]+\\.)*(?:(?:microsoft|lionbridge).com)");e.userInfo[r].userInEditorPreview=r===t.USER_TYPE.O365&&n.email&&s.test(n.email),i.set(e),o.resolve(e.userInfo[r])})),o.promise}function O(e,r){a(e).lookupUserInfo(r,(function(r){BrowserHandler.runtime.sendMessage({activity:t.ACTIVITY.USERINFO_AVAILABLE.NAME,data:r}),T(e,r),g(e,r)}))}function g(i,o){var s=e.defer(),u=n.get("$http");return i===t.USER_TYPE.O365&&(Utilities.isUndefinedOrNull(o)||Utilities.isUndefinedOrNull(o.email))?(s.reject(),s.promise):(u({method:"GET",url:i===t.USER_TYPE.MSA?t.MSACONFIG.PHOTO_URL:String.format(t.O365CONFIG.PHOTO_URL,o.email),responseType:"blob",headers:{"X-UserType":i}}).success((function(e){r.trackEvent(String.format("UserService_GotServerPhoto_{0}",i));var n=new FileReader;n.onload=function(){p(i,(function(e){Utilities.isNotUndefinedOrNull(e)&&(e.photo=n.result,T(i,e))})),s.resolve(n.result)},n.readAsDataURL(e)})).error((function(e){s.reject(e)})),s.promise)}var v={acquireToken:l,authenticate:function(e,s){var u=a(e);Utilities.isUndefinedOrNull(u)?r.error("userService.authenticate - Invalid type"):function(e,o,s){var u=e.getConfig();if(Utilities.isUndefinedOrNull(e))return r.error("userService.acquireTokenFromCode - Invalid type"),void s(null);u.params.grant_type=t.OAUTH.AUTH_CODE,u.params.code=o,n.get("$http")({method:"POST",url:u.url,headers:{"Content-Type":"application/x-www-form-urlencoded;charset=utf-8"},data:$.param(u.params)}).success((function(r){U(u.resource,r),d(e.type,r),i.set({userType:e.type}),O(e.type,r),s(r.access_token)})).error((function(){s(null)}))}(u,s,(function(e){Utilities.isUndefinedOrNull(e)?u.type===t.USER_TYPE.O365&&o.show(t.NOTIFICATION.INVALIDSUBSCRIPTION):r.trackEvent(String.format("Authorization_Success_{0}",u.type))}))},clearToken:f,getLoginStatus:c,getUserType:function(){var r=e.defer();return c((function(e){if(!e)return r.resolve(t.USER_TYPE.NONE),r.promise;i.get("userType").then((function(e){Utilities.isUndefinedOrNull(e.userType)?r.resolve(t.USER_TYPE.NONE):r.resolve(e.userType)}))})),r.promise},getUserInfo:p,waitForUserInfo:function(n){var i=e.defer();return v.getUserInfo(n,(function(e){if(Utilities.isNotUndefinedOrNull(e))return i.resolve(e),i.promise;BrowserHandler.runtime.onMessage.addListener(u);var o=Utilities.isExtensionInTestingMode()?t.TIMEOUT.USER_INFO_LOOKUP_TEST:t.TIMEOUT.USER_INFO_LOOKUP,s=setTimeout((function(){r.warn(String.format("userService.waitForUserInfo timed out after {0} ms - {1}",t.TIMEOUT.USER_INFO_LOOKUP,n)),BrowserHandler.runtime.onMessage.removeListener(u),i.resolve(e)}),o);function u(e){e.activity===t.ACTIVITY.USERINFO_AVAILABLE.NAME&&(BrowserHandler.runtime.onMessage.removeListener(u),clearTimeout(s),i.resolve(e.data))}})),i.promise},saveUserInfo:T,login:function(e){var n=a(e);Utilities.isUndefinedOrNull(n)?r.error("userService.login - Invalid type"):BrowserHandler.tabs.create({url:n.getConfig().loginUrl},(function(e){i.set({loginTabId:e.id})}))},logout:function(e){f();var t=a(e);Utilities.isUndefinedOrNull(t)?r.error("userService.logout - Invalid type"):n.get("$http")({method:"GET",url:t.getConfig().logoutUrl}).success((function(){r.debug(String.format("userService.logout - {0}",e))}))},getUserPhoto:function(){var n=e.defer();return v.getUserType().then((function(e){if(e===t.USER_TYPE.NONE)return r.warn("UserService.getUserPhoto: no signed-in user"),n.reject(t.RECENTS.ERROR.UNSUPPORTED_USER_TYPE),n.promise;v.getUserInfo(e,(function(t){if(Utilities.isNotUndefinedOrNull(t)&&Utilities.isNotUndefinedOrNull(t.photo))return r.trackEvent(String.format("UserService_GotLocalPhoto_{0}",e)),n.resolve(t.photo),n.promise;n.reject("No photo in local storage")}))})),n.promise},getPhotoFromServer:g,lookupUserInfo:O};return v}])}();